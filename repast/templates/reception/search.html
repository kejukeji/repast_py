{% extends "reception/web_base.html" %}
{% block head %}
        {{ super() }}
{% endblock %}
{% block title %} 餐厅列表 {% endblock %}
{% block pager_js %}
<script type="text/javascript">
$(function () {
    var g_belong_province_id = 9;
    var g_belong_city_id = '';
    var g_belong_county_id = '';
    var block = $('.btn-block');
    block.bind('click', function () {
        window.location.href = '/reservation'
    });
    $('#searchButton').click(function () {
        str = $('#text').val();
        $.ajax({
            type: 'get',
            url: '/restful/searchStore?keyword=' + str,
            dataType: 'json',
            success: function (data) {
                var j = data;
                $.each(j.stores, function (idx, item) {
                    $('#result').append(
                            '<div id="bg">' +
                                    '<div class="xinxi">' +
                                    '<ul style="width:98%; margin:auto; padding-top:5px;">' +
                                    '<li class="fl"><img src="/static/images/stores/img.jpg" width="100px" height="100px"/></li>' +
                                    '<li class="fl" style="padding-left:5px; width:63%;">' +
                                    '<ul class="right">' +
                                    '<li><a href="###" class="name">' + item.name + '</a></li>' +

                                    '<li style="font-size:12px; font-family:"黑体"; color:#999;">地点：' + item.address + '</li>' +
                                    '<li class="dizhi">300m</li>' +
                                    '</ul>' +

                                    '</li>' +
                                    '</ul>' +

                                    '</div>' +
                                    '<div class="clear"></div>' +
                                    '<div class="text">' +
                                    '<p><a href="#">' + item.description + '</a></p>' +
                                    '</div>' +
                                    '<div class="button">' +
                                    '<button type="submit" class="btn btn-primary btn-lg btn-block">去排队</button>' +
                                    '<div class="img"></div>' +
                                    '</div>' +
                                    '</div>');
                });
            }
        });
    });
    function positonStore() {
        var province = $('#province_id').val();
        var city = $('#city_id').val();
        var county = $('#county_id').val();
        var latitude = {{ latitude }};
        var longitude = {{ longitude }};
        $.ajax({
            type: 'get',
            url: '/restful/positionStoreXY?province=' + province + '&city=' + city + '&county=' + county + '&latitude=' + latitude + '&longitude=' + longitude,
            dataType: 'json',
            success: function (data) {
                if(data.stores == null || data.stores == ''){
                    $('#result').append('<div id="bg">没有找到相应的餐厅，您可以<a href="/to_search_position">通过地区选择</a>！</div>');
                }
                else{
                    $('#result').empty();
                    $.each(data.stores, function (idx, item) {
                            $('#result').append(
                                    '<div id="bg">' +
                                            '<div class="xinxi">' +
                                            '<ul style="width:98%; margin:auto; padding-top:5px;">' +
                                            '<li class="fl"><img src="' + item.rel_path + '/' + item.picture_name + '" width="100px" height="100px"/></li>' +
                                            '<li class="fl" style="padding-left:5px; width:63%;">' +
                                            '<ul class="right">' +
                                            '<li><a href="###" class="name">' + item.name + '</a></li>' +
                                            '<li style="font-size:12px; font-family:"黑体"; color:#999;">地点：' + item.address + '</li>' +
                                            '<li class="dizhi">' + item.distance + '米</li>' +
                                            '</ul>' +

                                            '</li>' +
                                            '</ul>' +

                                            '</div>' +
                                            '<div class="clear"></div>' +
                                            '<div class="text">' +
                                            '<p><a href="#">' + item.description + '</a></p>' +
                                            '</div>' +
                                            '<div class="button">' +
                                            '<a href="/queue/' + item.id + '"  type="button" class="btn btn-primary btn-lg btn-block">去排队</a>' +
                                            '<div class="img"></div>' +
                                            '</div>' +
                                            '</div>');

                    });

                }
            }
        });

    }


    //定义省份change事件
    var province = $("#province_id");
    province.bind('change', function () {
        var province_val = province.val();
        get_city(province, province_val, '', '');
        var city_val = $("#city_id");
        get_county(province, city_val, city_val.val(), "");
        positonStore();
    });
    //定义城市cahnge事件
    var city = $("#city_id");
    city.bind('change', function () {
        get_county(province, city, city.val(), "");
        positonStore();
    });
    var county = $("#county_id");
    county.bind('change', function () {
        positonStore();
    });

    function init_location(init_province, init_city, init_county) {
        var province = $('#province_id');
        $.ajax({
            type: "GET",
            url: "/restful/province",
            dataType: "json",
            async: false,
            cache: false,
            success: function (json) {
                province.empty();
                $.each(json, function (i, value) {
                    if (g_belong_province_id == value[0]) {
                        $("#province_id").append($("<option>").text(value[1]).attr('value', value[0]).attr('selected', 'selected'));
                    } else {
                        $("#province_id").append($("<option>").text(value[1]).attr('value', value[0]));
                    }
                });
                province.val(init_province);
                g_belong_province_id = init_province;
            },
            error: function () {
                {#                alert("获取省资料失败，请刷新网页！");#}
            }
        });
        get_city(province, init_province, init_city, init_county)

    }

    // 如果是新建的话，这几个id是不存在的，无法获取，使用默认参数

    if (g_belong_province_id != "") {
        init_location(g_belong_province_id, g_belong_city_id, g_belong_county_id)
    } else {
        init_location("9", "", "")
    }
    positonStore();
    function get_city(province, init_province, init_city, init_county) {
        var city = $('#city_id');
        $.ajax({
            type: "GET",
            url: "/restful/city/" + init_province,
            dataType: "json",
            async: false,
            cache: false,
            success: function (json) {
                city.empty().append($("<option>").text('市/县').attr('value', '0').attr('selected', 'selected'));
                $.each(json, function (i, value) {
                    if (g_belong_city_id == value[0]) {
                        $("#city_id").append($("<option>").text(value[1]).attr('value', value[0]));
                    } else {
                        $("#city_id").append($("<option>").text(value[1]).attr('value', value[0]));
                    }

                });
                if (init_city != '') {
                    city.val(init_city);
                    g_belong_city_id = init_city;
                }
            },
            error: function () {
                {#                    alert("获取市资料失败，请刷新网页！");#}
            }
        });
        get_county(province, city, init_city, init_county)
    }

    function get_county(province, city, init_city, init_county) {
        var county = $('#county_id');
        $.ajax({
            type: "GET",
            url: "/restful/county/" + init_city,
            dataType: "json",
            async: false,
            cache: false,
            success: function (json) {
                county.empty().append($("<option>").text('区').attr('value', '0').attr('selected', 'selected'));
                if (json.length == 0) {
                    $("#county_id").append($("<option>").text("").attr('value', "0"));
                } else {
                    $.each(json, function (i, value) {
                        if (g_belong_county_id == value[0]) {
                            $("#county_id").append($("<option>").text(value[1]).attr('value', value[0]));
                        } else {
                            $("#county_id").append($("<option>").text(value[1]).attr('value', value[0]));
                        }
                    });
                    if (init_county != "") {
                        county.val(init_county);
                        g_belong_county_id = init_county;
                    }
                }
            },
            error: function () {
                //alert("当前城市没有区！");
            }
        });
    }
});
</script>
{% endblock %}
{% block content %}
<body style="background:#EFF2F5; font-family:'微软雅黑';">
<div class="toptitle">
<b>您身边的餐饮助手</b>
</div>
<!--搜索框-->
{#<div id="search">#}

{#    <input id="text" type="text" style="border-radius:12px;" class="noneinput" placeholder="请输入关键字"/></div>#}
{#<div class="sou"><a href="#" id="searchButton"><img src="/static/images/stores/sou.png"/></a></div>#}
<!--搜索框结束-->
<!--地区--->
<div class="id" style="display: none">
    <div class="idbg">
        <span>
             <select name='province_id' id='province_id' style="width: 30%">

             </select>

             <select name='city_id' id='city_id' style="width: 30%">
                 <option value=0 selected>市/县</option>
             </select>
             <select name='county_id' id='county_id' style="width: 30%">
                 <option value=0 selected>区</option>
             </select>
        </span>
    </div>
</div>
<div>您现在的位置是：{{ description }}</div>
<div id="result">
</div>

<!--搜索框结果-->


</body>
{% block foot %}
    {{ super() }}
{% endblock %}
{% endblock %}

